Домашнее задание к занятию "3.5. Файловые системы"
----------------------------------------------------------
----------------------------------------------------------  

1. Разрежённый файл (англ. sparse file) — файл, в котором последовательности нулевых байтов заменены на информацию об этих последовательностях (список дыр). 
Информация о дырах (смещение от начала файла в байтах и количество байт) хранится в метаданных ФС.   
Следующие ФС поддерживают разрежённые файлы: BTRFS, NILFS, ZFS, NTFS[2], ext2, ext3, ext4, XFS, JFS, ReiserFS, Reiser4, UFS, Rock Ridge, UDF, ReFS, APFS, F2FS.   
Для нашего случая актуально также то, что разрежённые файлы используются для хранения контейнеров, например:  
образов дисков виртуальных машин;  
резервных копий дисков и/или разделов, созданных спец. ПО.
Также, рассматривая все преимущества использования разрежённых файлов, хочется отметить, что для ВМ, которая используется для тестирования/обучения и не работает с большими объемами данных постоянно, экономия дискового пространства - наиболее важное из преимуществ. Использование разрежённых файлов считается одним из способов сжатия данных на уровне файловой системы.  
Такие недостатки, как:  
накладные расходы на работу со списком дыр;  
фрагментация файла при частой записи данных в дыры;  
невозможность записи данных в дыры при отсутствии свободного места на диске;  
в процессе тестирования/обучения с применением ВМ, вкупе с небольшими объемами хранимой/изменяемой информации на диске, не являются сколько-нибудь существенными.  
  
2. Жесткие ссылки на один и тот же файл не могут иметь разные права доступа и владельца. 
Во первых - жесткая ссылка по сути лишь указатель на физическое расположение файла на устройстве хранения ( диске ).  
Во вторых - наличие разных прав и владельцев для каждой такой жесткой ссылки ( если бы это было возможно ) нарушало бы требование безопасности и разграничения прав пользователей. Это по сути то же самое, что файл будет принадлежать разным владельцам и/или иметь разные права доступа ( которые могут даже и противоречить друг другу ).  
  
3. Удаление предыдущего Vagrant instance, создание нового instance:  
![01.png](img/01.png)  
 ..с двумя неразмеченными дисками по 2.5 Gb:  
![02.png](img/02.png)  
  
4. Первый диск разбит на два раздела с помощью fdisk:  
![03.png](img/03.png)  
  
5. Перенос ( копирование ) таблицы разделов, созданной на первом диске, на второй диск.  
Создание дампа таблицы:  
![04.png](img/04.png)  
  
```bash
vim sdb.dump
label: dos
label-id: 0x21e352e8
device: /dev/sdb
unit: sectors

/dev/sdb1 : start=        2048, size=     4194304, type=83
/dev/sdb2 : start=     4196352, size=     1046528, type=83
```  
Перенос таблицы на второй диск с помощью созданного дампа:  
![05.png](img/05.png)  
  
6. Сборка RAID1 на паре разделов по 2 Гб:  
![06.png](img/06.png)
![07.png](img/07.png)
  
7. Сборка RAID0 на второй паре маленьких разделов:  
![08.png](img/08.png)  
  
8. Создание 2 независимых PV на получившихся md-устройствах:  
![09.png](img/09.png)  
  
9. Создал общую volume-group на этих двух PV:  
![10.png](img/10.png)  
  
10. Создал LV размером 100 Мб, указав его расположение на PV с RAID0:  
![11.png](img/11.png)   
  
11. Создал ФС ext4 на получившемся LV:  
![12.png](img/12.png)  
  
12. Смонтировал этот раздел в `/tmp/new`:  
![13.png](img/13.png)  
  
13. Поместил туда тестовый файл `https://mirror.yandex.ru/ubuntu/ls-lR.gz`:
![14.png](img/14.png)
  
14. Вывод `lsblk`:  
```bash
vagrant@vagrant:~$ lsblk
NAME                      MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINT
loop1                       7:1    0 70.3M  1 loop  /snap/lxd/21029
loop2                       7:2    0 32.3M  1 loop  /snap/snapd/12704
loop3                       7:3    0 55.5M  1 loop  /snap/core18/2253
loop4                       7:4    0 43.3M  1 loop  /snap/snapd/14295
loop5                       7:5    0 61.9M  1 loop  /snap/core20/1270
loop6                       7:6    0 67.2M  1 loop  /snap/lxd/21835
loop7                       7:7    0 55.5M  1 loop  /snap/core18/2284
sda                         8:0    0   64G  0 disk  
├─sda1                      8:1    0    1M  0 part  
├─sda2                      8:2    0    1G  0 part  /boot
└─sda3                      8:3    0   63G  0 part  
  └─ubuntu--vg-ubuntu--lv 253:0    0 31.5G  0 lvm   /
sdb                         8:16   0  2.5G  0 disk  
├─sdb1                      8:17   0    2G  0 part  
│ └─md0                     9:0    0    2G  0 raid1 
└─sdb2                      8:18   0  511M  0 part  
  └─md1                     9:1    0 1018M  0 raid0 
    └─vg01-lv1            253:1    0  100M  0 lvm   /tmp/new
sdc                         8:32   0  2.5G  0 disk  
├─sdc1                      8:33   0    2G  0 part  
│ └─md0                     9:0    0    2G  0 raid1 
└─sdc2                      8:34   0  511M  0 part  
  └─md1                     9:1    0 1018M  0 raid0 
    └─vg01-lv1            253:1    0  100M  0 lvm   /tmp/new
```
15. Тестирование целостности файла:
![15.png](img/15.png)
  
16. Переместил содержимое PV с RAID0 на RAID1 при помощи pvmove:  
![16.png](img/16.png)  
  
17. Сделал --fail на устройство в моем RAID1 md:  
![17.png](img/17.png)  
  
18. Согласно вывода dmesg, RAID1 работает в деградированном состоянии:  
![18.png](img/18.png)  
  
19. Тестируем целостность файла: несмотря на "сбойный" диск, он продолжает быть доступен:
![19.png](img/19.png)

  

  



